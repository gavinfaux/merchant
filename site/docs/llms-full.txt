# Merchant — Complete API Documentation

> Open-source commerce backend for selling products online. Connect your Stripe account, deploy to Cloudflare Workers, and start selling.

Repository: https://github.com/withpluto/merchant
License: MIT

---

## Table of Contents

1. Overview
2. Quick Start
3. Authentication
4. Products API
5. Inventory API
6. Carts API
7. Checkout Flow
8. Orders API
9. Images API
10. Webhooks
11. Setup API
12. Error Handling
13. Database Schema
14. Deployment
15. Examples

---

## 1. Overview

Merchant is a minimal commerce backend that provides:
- Product catalog management with variants (SKUs)
- Inventory tracking with reservations
- Shopping cart with 30-minute expiry
- Stripe Checkout integration
- Order management with refunds
- Image uploads to R2

### Tech Stack
- Runtime: Cloudflare Workers (edge computing)
- Framework: Hono (lightweight web framework)
- Database: D1 (SQLite at the edge)
- Images: R2 (S3-compatible object storage)
- Payments: Stripe Checkout

### Dependencies
Only two npm packages:
- `hono` — Web framework
- `stripe` — Stripe SDK

---

## 2. Quick Start

### Prerequisites
- Node.js 18+
- npm
- Stripe account (for payments)
- Cloudflare account (for deployment)

### Local Development

```bash
# Clone repository
git clone https://github.com/withpluto/merchant
cd merchant

# Install dependencies
npm install

# Initialize store and database
npx tsx scripts/init.ts

# Start development server
npm run dev
# API runs at http://localhost:8787

# (Optional) Seed demo data
npx tsx scripts/seed.ts http://localhost:8787 sk_your_admin_key
```

### Connect Stripe

```bash
curl -X POST http://localhost:8787/v1/setup/stripe \
  -H "Authorization: Bearer sk_your_admin_key" \
  -H "Content-Type: application/json" \
  -d '{
    "stripe_secret_key": "sk_test_...",
    "stripe_webhook_secret": "whsec_..."
  }'
```

### Admin Dashboard

```bash
cd admin
npm install
npm run dev
```

---

## 3. Authentication

All API endpoints require authentication via Bearer token.

### Header Format
```
Authorization: Bearer <api_key>
```

### Key Types

| Prefix | Role | Permissions |
|--------|------|-------------|
| `pk_...` | public | Create carts, add items, checkout |
| `sk_...` | admin | Full access to all endpoints |

### Key Generation
Keys are generated during store initialization and shown only once. They are stored as SHA-256 hashes in the database.

### Permission Matrix

| Endpoint | Public (pk_) | Admin (sk_) |
|----------|--------------|-------------|
| GET /v1/products | ❌ | ✅ |
| POST /v1/products | ❌ | ✅ |
| PATCH /v1/products/:id | ❌ | ✅ |
| POST /v1/products/:id/variants | ❌ | ✅ |
| GET /v1/inventory | ❌ | ✅ |
| POST /v1/inventory/:sku/adjust | ❌ | ✅ |
| POST /v1/carts | ✅ | ✅ |
| POST /v1/carts/:id/items | ✅ | ✅ |
| POST /v1/carts/:id/checkout | ✅ | ✅ |
| GET /v1/orders | ❌ | ✅ |
| GET /v1/orders/:id | ❌ | ✅ |
| POST /v1/orders/:id/refund | ❌ | ✅ |
| POST /v1/orders/test | ❌ | ✅ |
| POST /v1/images | ❌ | ✅ |
| DELETE /v1/images/:key | ❌ | ✅ |
| POST /v1/setup/stripe | ❌ | ✅ |

---

## 4. Products API

Products contain variants. Each variant has a unique SKU and price.

### List Products

```http
GET /v1/products
Authorization: Bearer sk_...
```

**Response 200:**
```json
{
  "items": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "title": "Classic Tee",
      "description": "Premium cotton t-shirt",
      "status": "active",
      "created_at": "2025-01-01T00:00:00.000Z",
      "variants": [
        {
          "id": "660e8400-e29b-41d4-a716-446655440000",
          "sku": "TEE-BLK-S",
          "title": "Black / S",
          "price_cents": 2999,
          "image_url": null
        },
        {
          "id": "770e8400-e29b-41d4-a716-446655440000",
          "sku": "TEE-BLK-M",
          "title": "Black / M",
          "price_cents": 2999,
          "image_url": null
        }
      ]
    }
  ]
}
```

### Get Product

```http
GET /v1/products/{id}
Authorization: Bearer sk_...
```

**Response 200:** Same as single item in list response.

**Response 404:**
```json
{
  "error": {
    "code": "not_found",
    "message": "Product not found"
  }
}
```

### Create Product

```http
POST /v1/products
Authorization: Bearer sk_...
Content-Type: application/json

{
  "title": "Classic Tee",
  "description": "Premium cotton t-shirt"
}
```

**Required fields:** `title`
**Optional fields:** `description`

**Response 201:**
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "title": "Classic Tee",
  "description": "Premium cotton t-shirt",
  "status": "active",
  "variants": []
}
```

### Update Product

```http
PATCH /v1/products/{id}
Authorization: Bearer sk_...
Content-Type: application/json

{
  "title": "Updated Title",
  "description": "New description",
  "status": "draft"
}
```

**Optional fields:** `title`, `description`, `status`
**Status values:** `active`, `draft`

**Response 200:** Updated product with variants.

### Create Variant

```http
POST /v1/products/{id}/variants
Authorization: Bearer sk_...
Content-Type: application/json

{
  "sku": "TEE-BLK-M",
  "title": "Black / M",
  "price_cents": 2999,
  "image_url": "https://example.com/image.jpg"
}
```

**Required fields:** `sku`, `title`, `price_cents`
**Optional fields:** `image_url`

- `sku` must be unique within the store
- `price_cents` must be a positive integer
- Creating a variant automatically creates an inventory record with 0 stock

**Response 201:**
```json
{
  "id": "660e8400-e29b-41d4-a716-446655440000",
  "sku": "TEE-BLK-M",
  "title": "Black / M",
  "price_cents": 2999,
  "image_url": "https://example.com/image.jpg"
}
```

**Response 409 (duplicate SKU):**
```json
{
  "error": {
    "code": "conflict",
    "message": "SKU TEE-BLK-M already exists"
  }
}
```

---

## 5. Inventory API

Inventory is tracked per SKU with three quantities:
- `on_hand`: Total physical stock
- `reserved`: Stock reserved for pending checkouts
- `available`: `on_hand - reserved` (what can be sold)

### List Inventory

```http
GET /v1/inventory
Authorization: Bearer sk_...
```

**Response 200:**
```json
{
  "items": [
    {
      "sku": "TEE-BLK-M",
      "on_hand": 100,
      "reserved": 5,
      "available": 95,
      "variant_title": "Black / M",
      "product_title": "Classic Tee"
    }
  ]
}
```

### Get Inventory by SKU

```http
GET /v1/inventory?sku=TEE-BLK-M
Authorization: Bearer sk_...
```

**Response 200:**
```json
{
  "sku": "TEE-BLK-M",
  "on_hand": 100,
  "reserved": 5,
  "available": 95
}
```

### Adjust Inventory

```http
POST /v1/inventory/{sku}/adjust
Authorization: Bearer sk_...
Content-Type: application/json

{
  "delta": 50,
  "reason": "restock"
}
```

**Required fields:** `delta`, `reason`

**delta:** Integer (positive to increase, negative to decrease)

**reason values:**
- `restock` — Receiving new inventory
- `correction` — Fixing count errors
- `damaged` — Removing damaged items
- `return` — Processing customer returns

**Response 200:**
```json
{
  "sku": "TEE-BLK-M",
  "on_hand": 150,
  "reserved": 5,
  "available": 145
}
```

**Example: Decrease inventory**
```json
{
  "delta": -10,
  "reason": "damaged"
}
```

---

## 6. Carts API

Carts hold items for checkout. They expire after 30 minutes.

### Create Cart

```http
POST /v1/carts
Authorization: Bearer pk_... (or sk_...)
Content-Type: application/json

{
  "customer_email": "buyer@example.com"
}
```

**Required fields:** `customer_email` (must contain @)

**Response 200:**
```json
{
  "id": "880e8400-e29b-41d4-a716-446655440000",
  "status": "open",
  "currency": "USD",
  "customer_email": "buyer@example.com",
  "items": [],
  "expires_at": "2025-01-01T12:30:00.000Z"
}
```

### Add Items to Cart

```http
POST /v1/carts/{id}/items
Authorization: Bearer pk_... (or sk_...)
Content-Type: application/json

{
  "items": [
    {"sku": "TEE-BLK-M", "qty": 2},
    {"sku": "CAP-BLK", "qty": 1}
  ]
}
```

**Notes:**
- This REPLACES all items in the cart
- Each item requires `sku` and `qty > 0`
- Validates that SKU exists and is active
- Validates that sufficient inventory is available

**Response 200:**
```json
{
  "id": "880e8400-e29b-41d4-a716-446655440000",
  "status": "open",
  "currency": "USD",
  "customer_email": "buyer@example.com",
  "items": [
    {
      "sku": "TEE-BLK-M",
      "title": "Black / M",
      "qty": 2,
      "unit_price_cents": 2999
    },
    {
      "sku": "CAP-BLK",
      "title": "Black",
      "qty": 1,
      "unit_price_cents": 2499
    }
  ],
  "expires_at": "2025-01-01T12:30:00.000Z"
}
```

**Response 409 (insufficient inventory):**
```json
{
  "error": {
    "code": "insufficient_inventory",
    "message": "Insufficient inventory for SKU: TEE-BLK-M",
    "details": {
      "sku": "TEE-BLK-M"
    }
  }
}
```

### Cart Statuses
- `open` — Active, can add items and checkout
- `checked_out` — Checkout initiated
- `expired` — Cart expired (cleaned up by cron)

---

## 7. Checkout Flow

### Initiate Checkout

```http
POST /v1/carts/{id}/checkout
Authorization: Bearer pk_... (or sk_...)
Content-Type: application/json

{
  "success_url": "https://yoursite.com/thanks?session_id={CHECKOUT_SESSION_ID}",
  "cancel_url": "https://yoursite.com/cart"
}
```

**Required fields:** `success_url`, `cancel_url`

**What happens:**
1. Validates cart is open and has items
2. Reserves inventory for all items
3. Creates Stripe Checkout Session
4. Updates cart status to `checked_out`

**Response 200:**
```json
{
  "checkout_url": "https://checkout.stripe.com/c/pay/cs_test_...",
  "stripe_checkout_session_id": "cs_test_..."
}
```

**Next step:** Redirect the customer to `checkout_url`

### After Payment

When customer completes payment on Stripe:
1. Stripe sends `checkout.session.completed` webhook
2. Webhook handler creates order
3. Inventory is deducted (`on_hand` and `reserved` both decrease)
4. Customer is redirected to `success_url`

### Stripe URLs
- Use `{CHECKOUT_SESSION_ID}` in success_url to get the session ID for confirmation pages
- Example: `https://yoursite.com/thanks?session_id={CHECKOUT_SESSION_ID}`

---

## 8. Orders API

Orders are created automatically when Stripe payment completes.

### List Orders

```http
GET /v1/orders
Authorization: Bearer sk_...
```

**Response 200:**
```json
{
  "items": [
    {
      "id": "990e8400-e29b-41d4-a716-446655440000",
      "number": "ORD-0001",
      "status": "paid",
      "customer_email": "buyer@example.com",
      "ship_to": null,
      "amounts": {
        "subtotal_cents": 8497,
        "tax_cents": 0,
        "shipping_cents": 0,
        "total_cents": 8497,
        "currency": "USD"
      },
      "stripe": {
        "checkout_session_id": "cs_test_...",
        "payment_intent_id": "pi_..."
      },
      "items": [
        {
          "sku": "TEE-BLK-M",
          "title": "Black / M",
          "qty": 2,
          "unit_price_cents": 2999
        },
        {
          "sku": "CAP-BLK",
          "title": "Black",
          "qty": 1,
          "unit_price_cents": 2499
        }
      ],
      "created_at": "2025-01-01T12:35:00.000Z"
    }
  ]
}
```

### Get Order

```http
GET /v1/orders/{id}
Authorization: Bearer sk_...
```

**Response 200:** Same as single item in list response.

### Refund Order

```http
POST /v1/orders/{id}/refund
Authorization: Bearer sk_...
Content-Type: application/json

{
  "amount_cents": 2999
}
```

**Partial refund:** Specify `amount_cents`
**Full refund:** Omit `amount_cents`

**Response 200:**
```json
{
  "stripe_refund_id": "re_...",
  "status": "succeeded"
}
```

### Order Statuses
- `paid` — Payment completed
- `refunded` — Fully refunded
- `canceled` — Canceled (not used currently)

### Create Test Order

For development without Stripe:

```http
POST /v1/orders/test
Authorization: Bearer sk_...
Content-Type: application/json

{
  "customer_email": "test@example.com",
  "items": [
    {"sku": "TEE-BLK-M", "qty": 1}
  ]
}
```

Creates order immediately, deducts inventory, skips Stripe.

---

## 9. Images API

Upload product images to R2 storage.

### Upload Image

```http
POST /v1/images
Authorization: Bearer sk_...
Content-Type: multipart/form-data

file: <binary image data>
```

**Constraints:**
- Max file size: 5MB
- Allowed types: image/jpeg, image/png, image/webp, image/gif

**Response 200:**
```json
{
  "url": "https://your-r2-url.com/store_id/uuid.jpg",
  "key": "store_id/uuid.jpg"
}
```

Use the `url` in variant `image_url` field.

### Get Image

```http
GET /v1/images/{key}
```

No authentication required. Returns image with cache headers.

### Delete Image

```http
DELETE /v1/images/{key}
Authorization: Bearer sk_...
```

Can only delete images belonging to your store.

**Response 200:**
```json
{
  "ok": true
}
```

---

## 10. Webhooks

### Stripe Webhook Endpoint

```
POST /v1/webhooks/stripe
```

Configure in Stripe Dashboard:
1. Go to Developers → Webhooks
2. Add endpoint: `https://your-domain.com/v1/webhooks/stripe`
3. Select events: `checkout.session.completed`
4. Copy webhook secret and add to setup

### Events Handled

| Event | Action |
|-------|--------|
| `checkout.session.completed` | Creates order, deducts inventory |

### Local Development

Use Stripe CLI to forward webhooks:

```bash
stripe listen --forward-to localhost:8787/v1/webhooks/stripe
```

Copy the webhook secret printed by the CLI and use it in setup.

### Webhook Security
- Signature verified using `stripe_webhook_secret`
- Events are deduplicated by `stripe_event_id`
- Store ID extracted from session metadata

---

## 11. Setup API

### Connect Stripe

```http
POST /v1/setup/stripe
Authorization: Bearer sk_...
Content-Type: application/json

{
  "stripe_secret_key": "sk_test_...",
  "stripe_webhook_secret": "whsec_..."
}
```

**Required fields:** `stripe_secret_key`
**Optional fields:** `stripe_webhook_secret`

- `stripe_secret_key` must start with `sk_`
- `stripe_webhook_secret` must start with `whsec_`
- Key is validated against Stripe API before saving

**Response 200:**
```json
{
  "ok": true
}
```

### Get Stripe Keys
- Test keys: https://dashboard.stripe.com/test/apikeys
- Live keys: https://dashboard.stripe.com/apikeys

---

## 12. Error Handling

### Error Response Format

```json
{
  "error": {
    "code": "error_code",
    "message": "Human readable message",
    "details": {}
  }
}
```

### Error Codes

| Code | HTTP Status | Description |
|------|-------------|-------------|
| `unauthorized` | 401 | Missing or invalid API key |
| `forbidden` | 403 | Key doesn't have permission |
| `not_found` | 404 | Resource not found |
| `invalid_request` | 400 | Bad request data |
| `conflict` | 409 | Resource conflict (duplicate SKU, cart not open) |
| `insufficient_inventory` | 409 | Not enough stock |
| `stripe_error` | 502 | Stripe API error |
| `webhook_signature_invalid` | 400 | Invalid webhook signature |
| `internal` | 500 | Internal server error |

---

## 13. Database Schema

### Tables

**stores**
```sql
id TEXT PRIMARY KEY
name TEXT NOT NULL
status TEXT ('disabled', 'enabled')
stripe_secret_key TEXT
stripe_webhook_secret TEXT
created_at TEXT
```

**api_keys**
```sql
id TEXT PRIMARY KEY
store_id TEXT REFERENCES stores(id)
key_hash TEXT UNIQUE
key_prefix TEXT ('pk_', 'sk_')
role TEXT ('public', 'admin')
created_at TEXT
```

**products**
```sql
id TEXT PRIMARY KEY
store_id TEXT REFERENCES stores(id)
title TEXT NOT NULL
description TEXT
status TEXT ('active', 'draft')
created_at TEXT
```

**variants**
```sql
id TEXT PRIMARY KEY
product_id TEXT REFERENCES products(id)
store_id TEXT REFERENCES stores(id)
sku TEXT NOT NULL
title TEXT NOT NULL
price_cents INTEGER NOT NULL
currency TEXT DEFAULT 'USD'
weight_g INTEGER
image_url TEXT
status TEXT ('active', 'draft')
created_at TEXT
UNIQUE(store_id, sku)
```

**inventory**
```sql
id TEXT PRIMARY KEY
store_id TEXT REFERENCES stores(id)
sku TEXT NOT NULL
on_hand INTEGER DEFAULT 0
reserved INTEGER DEFAULT 0
updated_at TEXT
UNIQUE(store_id, sku)
```

**carts**
```sql
id TEXT PRIMARY KEY
store_id TEXT REFERENCES stores(id)
status TEXT ('open', 'checked_out', 'expired')
customer_email TEXT NOT NULL
currency TEXT DEFAULT 'USD'
stripe_checkout_session_id TEXT
expires_at TEXT NOT NULL
created_at TEXT
```

**cart_items**
```sql
id TEXT PRIMARY KEY
cart_id TEXT REFERENCES carts(id)
sku TEXT NOT NULL
title TEXT NOT NULL
qty INTEGER NOT NULL
unit_price_cents INTEGER NOT NULL
```

**orders**
```sql
id TEXT PRIMARY KEY
store_id TEXT REFERENCES stores(id)
number TEXT NOT NULL
status TEXT ('paid', 'refunded', 'canceled')
customer_email TEXT NOT NULL
ship_to TEXT (JSON)
subtotal_cents INTEGER NOT NULL
tax_cents INTEGER NOT NULL
shipping_cents INTEGER DEFAULT 0
total_cents INTEGER NOT NULL
currency TEXT DEFAULT 'USD'
stripe_checkout_session_id TEXT
stripe_payment_intent_id TEXT
created_at TEXT
```

**order_items**
```sql
id TEXT PRIMARY KEY
order_id TEXT REFERENCES orders(id)
sku TEXT NOT NULL
title TEXT NOT NULL
qty INTEGER NOT NULL
unit_price_cents INTEGER NOT NULL
```

---

## 14. Deployment

### Deploy to Cloudflare Workers

```bash
# 1. Create D1 database
wrangler d1 create merchant-db
# Copy database_id to wrangler.toml

# 2. Create R2 bucket
wrangler r2 bucket create merchant-images

# 3. Deploy
wrangler deploy

# 4. Initialize production database
npx tsx scripts/init.ts --remote
```

### wrangler.toml

```toml
name = "merchant"
main = "src/index.ts"
compatibility_date = "2025-12-01"

[[d1_databases]]
binding = "DB"
database_name = "merchant-db"
database_id = "your-database-id"

[[r2_buckets]]
binding = "IMAGES"
bucket_name = "merchant-images"

[vars]
IMAGES_URL = "https://your-r2-public-url"

[triggers]
crons = ["*/15 * * * *"]
```

### Cron Job

Runs every 15 minutes to:
- Expire old carts
- Release reserved inventory from expired carts

---

## 15. Examples

### Complete Checkout Flow

```bash
# 1. Create cart
CART=$(curl -s -X POST http://localhost:8787/v1/carts \
  -H "Authorization: Bearer pk_..." \
  -H "Content-Type: application/json" \
  -d '{"customer_email":"buyer@example.com"}')

CART_ID=$(echo $CART | jq -r '.id')

# 2. Add items
curl -X POST http://localhost:8787/v1/carts/$CART_ID/items \
  -H "Authorization: Bearer pk_..." \
  -H "Content-Type: application/json" \
  -d '{"items":[{"sku":"TEE-BLK-M","qty":2},{"sku":"CAP-BLK","qty":1}]}'

# 3. Checkout
curl -X POST http://localhost:8787/v1/carts/$CART_ID/checkout \
  -H "Authorization: Bearer pk_..." \
  -H "Content-Type: application/json" \
  -d '{"success_url":"https://site.com/thanks","cancel_url":"https://site.com/cart"}'
```

### Create Product with Variants

```bash
# Create product
PRODUCT=$(curl -s -X POST http://localhost:8787/v1/products \
  -H "Authorization: Bearer sk_..." \
  -H "Content-Type: application/json" \
  -d '{"title":"Hoodie","description":"Cozy pullover"}')

PRODUCT_ID=$(echo $PRODUCT | jq -r '.id')

# Add variants
curl -X POST http://localhost:8787/v1/products/$PRODUCT_ID/variants \
  -H "Authorization: Bearer sk_..." \
  -H "Content-Type: application/json" \
  -d '{"sku":"HOOD-BLK-M","title":"Black / M","price_cents":5999}'

curl -X POST http://localhost:8787/v1/products/$PRODUCT_ID/variants \
  -H "Authorization: Bearer sk_..." \
  -H "Content-Type: application/json" \
  -d '{"sku":"HOOD-BLK-L","title":"Black / L","price_cents":5999}'

# Add inventory
curl -X POST http://localhost:8787/v1/inventory/HOOD-BLK-M/adjust \
  -H "Authorization: Bearer sk_..." \
  -H "Content-Type: application/json" \
  -d '{"delta":50,"reason":"restock"}'

curl -X POST http://localhost:8787/v1/inventory/HOOD-BLK-L/adjust \
  -H "Authorization: Bearer sk_..." \
  -H "Content-Type: application/json" \
  -d '{"delta":40,"reason":"restock"}'
```

### Process Refund

```bash
# Get order
ORDER=$(curl -s http://localhost:8787/v1/orders/ORDER_ID \
  -H "Authorization: Bearer sk_...")

# Full refund
curl -X POST http://localhost:8787/v1/orders/ORDER_ID/refund \
  -H "Authorization: Bearer sk_..." \
  -H "Content-Type: application/json"

# Partial refund
curl -X POST http://localhost:8787/v1/orders/ORDER_ID/refund \
  -H "Authorization: Bearer sk_..." \
  -H "Content-Type: application/json" \
  -d '{"amount_cents":2999}'
```

---

## Building with AI

This API is designed to be AI-friendly:

1. **Simple REST patterns** — Standard CRUD operations
2. **Consistent responses** — Same format for all endpoints
3. **Clear error messages** — Machine-parseable error codes
4. **Minimal setup** — One command to start

### AI Integration Tips

- Use the admin key (`sk_...`) for full control
- Create test orders with `POST /v1/orders/test` to skip Stripe
- All prices are in cents (e.g., $29.99 = 2999)
- SKUs should be unique, descriptive identifiers

### Example: AI Commerce Agent

```python
import requests

API_URL = "http://localhost:8787"
API_KEY = "sk_..."

def create_product(title, description):
    return requests.post(
        f"{API_URL}/v1/products",
        headers={"Authorization": f"Bearer {API_KEY}"},
        json={"title": title, "description": description}
    ).json()

def add_variant(product_id, sku, title, price_cents):
    return requests.post(
        f"{API_URL}/v1/products/{product_id}/variants",
        headers={"Authorization": f"Bearer {API_KEY}"},
        json={"sku": sku, "title": title, "price_cents": price_cents}
    ).json()

def add_inventory(sku, quantity):
    return requests.post(
        f"{API_URL}/v1/inventory/{sku}/adjust",
        headers={"Authorization": f"Bearer {API_KEY}"},
        json={"delta": quantity, "reason": "restock"}
    ).json()
```

---

End of documentation.

